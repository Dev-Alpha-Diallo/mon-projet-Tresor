# ğŸ“ Documentation Technique - Architecture

## Vue d'ensemble

Cette application Laravel suit une architecture **MVC (Model-View-Controller)** claire et bien structurÃ©e, avec une couche de services pour la logique mÃ©tier complexe.

## ğŸ—ï¸ Architecture gÃ©nÃ©rale

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Utilisateur (Web)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Routes (web.php)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Controllers (HTTP)              â”‚
â”‚  - DashboardController                  â”‚
â”‚  - EtudiantController                   â”‚
â”‚  - PaiementController                   â”‚
â”‚  - FactureController                    â”‚
â”‚  - MaisonController                     â”‚
â”‚  - BailleurController                   â”‚
â”‚  - RapportController                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Models â”‚    â”‚Services â”‚    â”‚ Views  â”‚
â”‚(ORM)  â”‚    â”‚         â”‚    â”‚(Blade) â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  SQLite   â”‚
    â”‚ Database  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Structure des dossiers

```
app/
â”œâ”€â”€ Http/
â”‚   â””â”€â”€ Controllers/          # ContrÃ´leurs HTTP
â”‚       â”œâ”€â”€ DashboardController.php
â”‚       â”œâ”€â”€ EtudiantController.php
â”‚       â”œâ”€â”€ PaiementController.php
â”‚       â”œâ”€â”€ FactureController.php
â”‚       â”œâ”€â”€ MaisonController.php
â”‚       â”œâ”€â”€ BailleurController.php
â”‚       â””â”€â”€ RapportController.php
â”‚
â”œâ”€â”€ Models/                   # ModÃ¨les Eloquent (ORM)
â”‚   â”œâ”€â”€ Bailleur.php
â”‚   â”œâ”€â”€ Maison.php
â”‚   â”œâ”€â”€ Etudiant.php
â”‚   â”œâ”€â”€ Paiement.php
â”‚   â”œâ”€â”€ Facture.php
â”‚   â””â”€â”€ PaiementBailleur.php
â”‚
â””â”€â”€ Services/                 # Logique mÃ©tier
    â””â”€â”€ RapportService.php

database/
â”œâ”€â”€ migrations/               # SchÃ©ma de base de donnÃ©es
â”‚   â”œâ”€â”€ *_create_bailleurs_table.php
â”‚   â”œâ”€â”€ *_create_maisons_table.php
â”‚   â”œâ”€â”€ *_create_etudiants_table.php
â”‚   â”œâ”€â”€ *_create_paiements_table.php
â”‚   â”œâ”€â”€ *_create_factures_table.php
â”‚   â””â”€â”€ *_create_paiements_bailleurs_table.php
â”‚
â””â”€â”€ seeders/                  # DonnÃ©es de test
    â””â”€â”€ DemoDataSeeder.php

resources/views/              # Templates Blade
â”œâ”€â”€ layouts/
â”‚   â””â”€â”€ app.blade.php
â”œâ”€â”€ dashboard/
â”œâ”€â”€ etudiants/
â”œâ”€â”€ paiements/
â”œâ”€â”€ factures/
â”œâ”€â”€ maisons/
â”œâ”€â”€ bailleurs/
â””â”€â”€ rapports/

routes/
â””â”€â”€ web.php                   # Routes HTTP
```

## ğŸ—„ï¸ SchÃ©ma de base de donnÃ©es

### Relations

```
bailleurs (1) â”€â”€â”€â”€â”€< (N) maisons
                        â”‚
                        â”‚ (1)
                        â”‚
                        â”œâ”€â”€â”€â”€< (N) etudiants
                        â”‚         â”‚
                        â”‚         â”‚ (1)
                        â”‚         â”‚
                        â”‚         â””â”€â”€â”€â”€< (N) paiements
                        â”‚
                        â””â”€â”€â”€â”€< (N) factures
```

### Tables principales

#### `bailleurs`
```sql
- id
- nom
- telephone
- timestamps
```

#### `maisons`
```sql
- id
- nom
- adresse
- bailleur_id (FK)
- loyer_total_mensuel
- timestamps
```

#### `etudiants`
```sql
- id
- nom
- filiere
- maison_id (FK)
- chambre
- loyer_mensuel
- timestamps
```

#### `paiements`
```sql
- id
- etudiant_id (FK)
- montant
- date_paiement
- moyen_paiement (enum: especes, mobile_money, virement)
- remarque
- timestamps
```

#### `factures`
```sql
- id
- numero_facture (unique)
- type (enum: eau, electricite, reparation, autre)
- maison_id (FK)
- montant
- date_paiement
- description
- timestamps
```

#### `paiements_bailleurs`
```sql
- id
- bailleur_id (FK)
- maison_id (FK)
- montant
- date_paiement
- remarque
- timestamps
```

## ğŸ§® Logique de calcul des soldes

### 1. Solde Ã©tudiant

**Formule :**
```php
Solde = Total payÃ© - Total dÃ»
```

**Calcul du total dÃ» :**
```php
Total dÃ» = Loyer mensuel Ã— Nombre de mois depuis inscription
```

**ImplÃ©mentation :**
```php
// Dans Etudiant.php
public function getSoldeAttribute(): float
{
    return $this->total_paye - $this->total_du;
}

public function getTotalDuAttribute(): float
{
    $moisDepuisInscription = Carbon::parse($this->created_at)
        ->diffInMonths(Carbon::now()) + 1;
    return $this->loyer_mensuel * $moisDepuisInscription;
}
```

### 2. Solde maison

**Formule :**
```php
Solde = Recettes - DÃ©penses - Paiements au bailleur
```

**ImplÃ©mentation :**
```php
// Dans Maison.php
public function getSoldeAttribute(): float
{
    return $this->total_recettes 
         - $this->total_depenses 
         - $this->total_paye_bailleur;
}
```

### 3. Solde global

**Formule :**
```php
Solde caisse = Total paiements Ã©tudiants - Total factures
```

**ImplÃ©mentation :**
```php
// Dans RapportService.php
$totalRecettes = Paiement::sum('montant');
$totalDepenses = Facture::sum('montant');
$soldeCaisse = $totalRecettes - $totalDepenses;
```

## ğŸ¯ Patterns et bonnes pratiques

### 1. Repository Pattern (implicite via Eloquent)

Les modÃ¨les Eloquent agissent comme des repositories :
```php
// RÃ©cupÃ©ration simple
$etudiants = Etudiant::all();

// Avec relations
$etudiants = Etudiant::with('maison', 'paiements')->get();

// Filtrage
$debiteurs = Etudiant::all()->filter(fn($e) => $e->isDebiteur());
```

### 2. Service Layer

La logique mÃ©tier complexe est dans `RapportService.php` :
```php
class RapportService
{
    public function genererRapportMensuel(int $mois, int $annee): string
    {
        // Collecte des donnÃ©es
        // GÃ©nÃ©ration PDF
        // Sauvegarde
    }
    
    private function collecterDonneesMensuelles(...) { }
    private function calculerSoldeJusquaDate(...) { }
}
```

### 3. Accessors Eloquent

Calculs automatiques via les accessors :
```php
// Dans le modÃ¨le
public function getSoldeAttribute(): float
{
    return $this->calculateSolde();
}

// Utilisation dans les vues
{{ $etudiant->solde }} // Appel automatique de getSoldeAttribute()
```

### 4. Resource Controllers

Routes RESTful complÃ¨tes :
```php
Route::resource('etudiants', EtudiantController::class);

// GÃ©nÃ¨re automatiquement :
// GET    /etudiants           -> index()
// GET    /etudiants/create    -> create()
// POST   /etudiants           -> store()
// GET    /etudiants/{id}      -> show()
// GET    /etudiants/{id}/edit -> edit()
// PUT    /etudiants/{id}      -> update()
// DELETE /etudiants/{id}      -> destroy()
```

## ğŸ“Š Flux de gÃ©nÃ©ration de rapport PDF

```
1. Utilisateur sÃ©lectionne mois/annÃ©e
   â”‚
   â–¼
2. RapportController::generer()
   â”‚
   â–¼
3. RapportService::genererRapportMensuel()
   â”‚
   â”œâ”€> Collecte donnÃ©es mensuelles
   â”‚   â”œâ”€> Paiements du mois
   â”‚   â”œâ”€> Factures du mois
   â”‚   â”œâ”€> Calcul soldes
   â”‚   â””â”€> Liste dÃ©biteurs/crÃ©diteurs
   â”‚
   â”œâ”€> GÃ©nÃ©ration PDF (DomPDF)
   â”‚   â””â”€> Vue: rapports/mensuel.blade.php
   â”‚
   â””â”€> Sauvegarde: storage/app/reports/
       â””â”€> rapport_tresorerie_YYYY_MM.pdf
```

## ğŸ” SÃ©curitÃ© et validation

### Validation des donnÃ©es

Chaque contrÃ´leur valide les donnÃ©es entrantes :
```php
$validated = $request->validate([
    'nom' => 'required|string|max:255',
    'filiere' => 'required|string|max:255',
    'maison_id' => 'required|exists:maisons,id',
    'chambre' => 'required|string|max:50',
    'loyer_mensuel' => 'required|numeric|min:0',
]);
```

### Protection CSRF

Tous les formulaires incluent `@csrf` :
```html
<form method="POST">
    @csrf
    <!-- champs -->
</form>
```

### Protection contre l'injection SQL

Eloquent utilise des requÃªtes prÃ©parÃ©es automatiquement :
```php
// SÃ©curisÃ© automatiquement
Etudiant::where('nom', $nom)->first();
```

## ğŸš€ Optimisations

### 1. Eager Loading

Ã‰viter le problÃ¨me N+1 :
```php
// âŒ Mauvais (N+1 queries)
$etudiants = Etudiant::all();
foreach ($etudiants as $etudiant) {
    echo $etudiant->maison->nom; // 1 query par Ã©tudiant
}

// âœ… Bon (2 queries seulement)
$etudiants = Etudiant::with('maison')->get();
foreach ($etudiants as $etudiant) {
    echo $etudiant->maison->nom;
}
```

### 2. Pagination

Pour les longues listes :
```php
$paiements = Paiement::with('etudiant.maison')
    ->latest('date_paiement')
    ->paginate(20);
```

### 3. Collections

Utilisation des collections Laravel :
```php
$debiteurs = $etudiants->filter(fn($e) => $e->isDebiteur());
$totalDettes = $debiteurs->sum('solde');
```

## ğŸ“ Convention de nommage

### ModÃ¨les
- Singulier, PascalCase
- Exemple : `Etudiant`, `Maison`, `Bailleur`

### Tables
- Pluriel, snake_case
- Exemple : `etudiants`, `maisons`, `bailleurs`

### ContrÃ´leurs
- Suffixe `Controller`
- Exemple : `EtudiantController`, `PaiementController`

### Routes
- Pluriel, kebab-case
- Exemple : `/etudiants`, `/paiements`, `/rapports`

### Vues
- Dossiers au pluriel, fichiers descriptifs
- Exemple : `etudiants/index.blade.php`, `etudiants/create.blade.php`

## ğŸ§ª Tests (recommandÃ©s pour production)

Structure de tests recommandÃ©e :
```
tests/
â”œâ”€â”€ Feature/
â”‚   â”œâ”€â”€ EtudiantTest.php
â”‚   â”œâ”€â”€ PaiementTest.php
â”‚   â””â”€â”€ RapportTest.php
â””â”€â”€ Unit/
    â”œâ”€â”€ Models/
    â”‚   â”œâ”€â”€ EtudiantTest.php
    â”‚   â””â”€â”€ MaisonTest.php
    â””â”€â”€ Services/
        â””â”€â”€ RapportServiceTest.php
```

Exemple de test :
```php
public function test_student_solde_is_calculated_correctly()
{
    $etudiant = Etudiant::factory()->create([
        'loyer_mensuel' => 100000
    ]);
    
    Paiement::factory()->create([
        'etudiant_id' => $etudiant->id,
        'montant' => 100000
    ]);
    
    $this->assertEquals(0, $etudiant->fresh()->solde);
}
```

## ğŸ“š Ressources

- [Documentation Laravel](https://laravel.com/docs)
- [Eloquent ORM](https://laravel.com/docs/eloquent)
- [Blade Templates](https://laravel.com/docs/blade)
- [Laravel DomPDF](https://github.com/barryvdh/laravel-dompdf)

---

**Cette architecture garantit un code maintenable, Ã©volutif et performant.**